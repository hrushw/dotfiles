#!/usr/bin/env bash

# Universal file/link opener

shopt -s nocasematch

open_in_term() {
	if [ -t 1 ]; then
		eval "$@"
	else
		xterm -e "$@" &>/dev/null &
	fi
}

arg="$@"
while file "$arg" | grep "symbolic link to" &>/dev/null; do
	arg="$(realpath "$arg")"
done

case "$arg" in
	"file://"*)
		arg=${arg:7}
esac

case "$arg" in
	"http://"* | "https://"*)
		firefox "$arg" &>/dev/null &
		exit 0;;

	"irc://"* | "ircs://"*)
		str="$(echo "$arg" | sed 's/^ircs*:\/\///' | sed 's/\// /')"
		host="$(echo "$str" | awk '{print $1}')"
		channel="$(echo "$str" | awk '{print $2}')"
		echo "$host" "$channel"
		catgirl -l -h "$host" -j "$channel"
		exit 0;;
esac

if [ ! -e "$arg" ]; then
	echo "ERROR: file '$arg' not found!"
	exit -1
fi

case "$arg" in
	*".html")
		firefox "$arg" &>/dev/null &;;

	*".md")
		tmpfmt="$(mktemp /tmp/mdfmt.XXXXXX)"
		lowdown -t term "$arg" > "$tmpfmt"
		open_in_term "$PAGER" "$tmpfmt"
		rm "$tmpfmt";;

	*".rst")
		tmpfmt="$(mktemp /tmp/mdfmt.XXXXXX)"
		pandoc "$arg" -t markdown | lowdown -t term > "$tmpfmt"
		open_in_term "$PAGER" "$tmpfmt"
		rm "$tmpfmt";;

	*".mkv" | *".mp4" | *".webm" | *".mov")
		mpv "$arg" &>/dev/null &;;

	*".flac" | *".opus" | *".mp3")
		mpv --vid=no "$arg";;
		# mpv "$arg" &>/dev/null &;;

	*".png" | *".jpg" | *".jpeg" | *".svg" | *".gif" | *".ppm" | *".pbm" | *".pgm" | *".ff" | *".webp")
		if [ "$KITTY_WINDOW_ID" -a -t 1 ]; then
			kitten icat --align left --transfer-mode="stream" --unicode-placeholder "$arg"
		else
			nsxiv --alpha-layer "$arg" &>/dev/null &
		fi;;

	*".dot")
		if [ "$KITTY_WINDOW_ID" -a -t 1 ]; then
			dot -Tkitty "$arg"
		else
			tmppng="$(mktemp /tmp/dotpng.XXXXXX)"
			dot -Tpng "$arg" > "$tmppng"
			(nsxiv "$tmppng" &>/dev/null; rm "$tmppng") &
		fi;;

	*".pdf" | *".djvu" | *".ps" | *".eps")
		zathura "$arg" &>/dev/null &;;

	*".txt" | *"/README" | "README")
		open_in_term "$PAGER" "$arg";;

	*".org")
		emacsclient -nc "$arg";;

	*)
		if file "$arg" | grep "directory"; then
			if [ -t 1 ]; then
				ls -al --color=auto --hyperlink=auto "$arg"
			else
				cd "$arg"
				xterm &
			fi
		elif file "$arg" | grep -e "ASCII text" -e "UTF-8 text" &>/dev/null; then
			if file "$arg" | grep "troff" &>/dev/null; then
				open_in_term man "$arg"
			else
				open_in_term "$PAGER" "$arg"
			fi
		elif file "$arg" | grep "broken" &>/dev/null; then
			file "$arg"
		else
			file "$arg"
		fi;;
esac
