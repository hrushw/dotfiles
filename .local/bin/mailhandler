#!/usr/bin/env bash

scan_format="%4n | %10d |%t %32f :  %2i%s"
mail_list() {
	mscan -f "$scan_format" 2>/dev/null
}

mail_process() {
	mlist $(mdirs) |
	msort -d |
	mthread |
	mseq -S
}

mail_select() {
	mail_list |
	tac |
	fzf |
	awk '{print $1}'
}

mail_view() {
	kitten @launch bash -c "mshow $@ | mcolor; read"
}

mail_img_show() {
	chafa -f kitty --exact-size auto -s "60x60" -c 8
	exit 62
}

mail_read() {
	# step 1: read
	case $1 in
		"")
			index=$(mail_select);;
		"grep")
			index=$(mail_grep ${@:2} | tac | fzf | awk '{print $1}');;
	esac


	case $index in
		"")
			echo "Selection failed";;
		*)
			mail_view $index;;
	esac
}

mail_extract() {
	case $1 in
		"")
			index=$(mscan -f "%c %n" | grep ">" | awk '{print $2}');;
		*)
			index=$1;;
	esac

	mshow -t $index |
	tail -n +2 |
	sed 's/^ *//' |
	awk '{print $1}' |
	rev |
	cut -c 2- |
	rev |
	xargs mshow -x $index
}

mail_grep() {
	pattern='subject =~~ "'$1'" || from =~~ "'$1'" || to =~~ "'$1'"'
	echo "$pattern"
	mpick -t "$pattern" | mail_list
}



case $1 in
	"list")
		mail_list;;
	"process")
		mail_process;;
	"select")
		mail_select;;
	"read")
		mail_read ${@:2};;
	"extract")
		mail_extract ${@:2};;
	"grep")
		mail_grep ${@:2};;
	"view")
		mail_view ${@:2};;
	"imgshow")
		mail_img_show ${@:2};;
	*)
		echo "Invalid Command!";;
esac


