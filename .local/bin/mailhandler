#!/bin/bash

mail_process() {
	mlist $(mdirs) |
	msort -d |
	mthread |
	mseq -S
}

mail_select() {
	mscan -f "%4n | %10d |%t %32f :  %2i%s" 2>/dev/null |
	tac |
	fzf |
	awk '{print $1}'
}

mail_read() {
	mshow $(mail_select) |
	mcolor
}

mail_extract() {
	mshow -t $1 |
	tail -n +2 |
	sed 's/^ *//' |
	awk '{print $1}' |
	rev |
	cut -c 2- |
	rev |
	xargs mshow -x $1
}

mail_grep() {
	pattern='subject =~~ "'$1'" || from =~~ "'$1'" || to =~~ "'$1'"'
	echo "$(mpick -t "$pattern" | mscan)"
}

case $1 in
	"process")
		mail_process;;
	"select")
		mail_select;;
	"read")
		mail_read;;
	"extract")
		mail_extract $2;;
	"grep")
		mail_grep $2;;
esac
