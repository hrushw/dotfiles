#!/bin/bash

scan_format="%4n | %10d |%t %32f :  %2i%s"
mail_list() {
	mscan -f "$scan_format" 2>/dev/null
}

mail_process() {
	mlist $(mdirs) |
	msort -d |
	mthread |
	mseq -S
}

mail_select() {
	mail_list |
	tac |
	fzf |
	awk '{print $1}'
}

mail_view() {
	mshow $1 | mcolor
}

mail_read() {
	# step 1: read
	case $1 in
		"")
			index=$(mail_select);;
		"grep")
			index=$(mail_grep $2 | tac | fzf | awk '{print $1}');;
	esac


	case $index in
		"")
			echo "Selection failed";;
		*)
			kitten @launch mailview $index;;
	esac
}

mail_extract() {
	mshow -t $1 |
	tail -n +2 |
	sed 's/^ *//' |
	awk '{print $1}' |
	rev |
	cut -c 2- |
	rev |
	xargs mshow -x $1
}

mail_grep() {
	pattern='subject =~~ "'$1'" || from =~~ "'$1'" || to =~~ "'$1'"'
	mpick -t "$pattern" | mail_list
}



case $1 in
	"list")
		mail_list;;
	"process")
		mail_process;;
	"select")
		mail_select;;
	"read")
		mail_read $2 $3;;
	"extract")
		mail_extract $2;;
	"grep")
		mail_grep $2;;
	"view")
		mail_view $2;;
esac


