#!/usr/bin/env bash

running=1
logfile=$XDG_STATE_HOME/offlineimap.log

togglerun() {
	if [ $running ]; then
		running=
		notify-send -t 10000 "Email sync toggled off"
	else
		running=1
		notify-send -t 10000 "Email sync toggled on"
	fi
}

trap togglerun SIGUSR1

sync() {
	{ date; echo; } &>> $logfile

	if [ $running ]; then
		if offlineimap &>> $logfile; then
			notify-send -t 10000 "Email synced successfully!"
		else
			notify-send "ERROR: Email sync failed!"
		fi
	else
		echo "sync disabled via SIGUSR1" &>> $logfile;
		notify-send -t 10000 "Mail sync disabled, waiting again"
	fi

	{ echo; mailhandler process; } &>> $logfile
	{ echo; echo; } >> $logfile
}

[ "$1" = "mono" ] && { sync; exit; }

pgrep -x "mailsync" && exit

while true; do
	snooze -H* -M/15

	sync
done
